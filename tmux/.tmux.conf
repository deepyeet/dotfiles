# ==============================================================================
# TMUX CONFIGURATION
# ==============================================================================
# Prefix: C-\ (Ctrl+Backslash) - doesn't conflict with vim's C-b or C-g
# Plugin manager: TPM (auto-installed if missing)
# ==============================================================================

# ------------------------------------------------------------------------------
# Prefix Key
# ------------------------------------------------------------------------------
# Using C-\ because:
#   C-b conflicts with vim's page-up
#   C-a conflicts with readline (jump to start of line)
#   C-g is vim's escape/cancel key
unbind-key C-b
set -g prefix 'C-\'
bind-key 'C-\' send-prefix

# ------------------------------------------------------------------------------
# Terminal Settings
# ------------------------------------------------------------------------------
# True color support for modern terminals
set -ga terminal-overrides ",alacritty:RGB,xterm-256color:RGB,xterm-ghostty:RGB"

# Faster escape (important for vim)
set -g escape-time 0

# Bigger scrollback
set -g history-limit 50000

# Focus events for vim autoread
set -g focus-events on

# Clipboard integration (OSC 52 - works over SSH)
set -gs set-clipboard on

# Don't kill server when last session closes (easier to reattach)
set -g detach-on-destroy off

# Enable mouse for scrolling and pane selection
set -g mouse on

# ------------------------------------------------------------------------------
# Vi-style Copy Mode
# ------------------------------------------------------------------------------
setw -g mode-keys vi
bind-key -T copy-mode-vi 'v' send -X begin-selection
bind-key -T copy-mode-vi 'y' send -X copy-selection
bind-key -T copy-mode-vi 'Y' send -X copy-line
# Enter/+ moves down and goes to indentation (like vim's +)
bind-key -T copy-mode-vi Enter send -X cursor-down \; send -X back-to-indentation
bind-key -T copy-mode-vi '+' send -X cursor-down \; send -X back-to-indentation
bind-key -T copy-mode-vi '_' send -X back-to-indentation
# Click clears selection instead of copying (less accidental copies)
bind-key -T copy-mode-vi MouseDown1Pane send -X clear-selection
unbind-key -T copy-mode-vi MouseDragEnd1Pane

# M-b enters copy mode and scrolls up a page (like vim's C-b)
bind -n M-b copy-mode -eu
bind -T copy-mode-vi M-f send -X page-down

# M-/ enters copy mode (M-c taken by fzf)
bind -n M-/ copy-mode

# ------------------------------------------------------------------------------
# Pane Navigation (Alt+hjkl - no prefix needed)
# ------------------------------------------------------------------------------
bind -n M-h select-pane -L
bind -n M-l select-pane -R
bind -n M-k select-pane -U
bind -n M-j select-pane -D

# ------------------------------------------------------------------------------
# Window Management
# ------------------------------------------------------------------------------
# M-t: New window
bind -n M-t new-window

# M-d/M-D: Split horizontal/vertical (at current path)
bind -n M-d split-window -h -c "#{pane_current_path}"
bind -n M-D split-window -c "#{pane_current_path}"

# M-p/M-n: Previous/next window
bind -n M-p previous-window
bind -n M-n next-window

# M-P/M-N: Move window left/right
bind -n M-P swap-window -t -1
bind -n M-N swap-window -t +1

# ------------------------------------------------------------------------------
# Session Management
# ------------------------------------------------------------------------------
bind -n M-C command-prompt "new-session -s %%"  # Create new session
bind -n M-S choose-session                       # Session picker
bind -n M-( switch-client -p                     # Previous session
bind -n M-) switch-client -n                     # Next session
bind -n M-` switch-client -l                     # Toggle last two sessions

# ------------------------------------------------------------------------------
# Pane Management
# ------------------------------------------------------------------------------
bind -n M-T break-pane   # Move pane to its own window
bind -n M-J choose-tree "join-pane -t '%%'"  # Join pane from another window
bind -n M-r next-layout  # Cycle through pane layouts

# ------------------------------------------------------------------------------
# Window Selection (Alt+number)
# ------------------------------------------------------------------------------
set -g base-index 1
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9
bind -n M-0 select-window -t 0

# ------------------------------------------------------------------------------
# Misc Bindings
# ------------------------------------------------------------------------------
bind -n M-, command-prompt -I "#W" "rename-window -- '%%'"
bind -n M-. command-prompt -I "#S" "rename-session -- '%%'"
bind -n M-w confirm-before -p "kill pane #P? (y/n)" kill-pane  # Like browser close-tab
bind -n M-z resize-pane -Z  # Toggle pane zoom
bind -n M-s run-shell -b "~/.tmux/plugins/tmux-jump/scripts/tmux-jump.sh"  # Flash-style jump
bind -n M-y run-shell -b "~/.tmux/plugins/tmux-thumbs/tmux-thumbs.sh"      # Quick-copy hints
bind r source-file ~/.tmux.conf \; display "Config reloaded"

# ==============================================================================
# PLUGINS (managed by TPM)
# ==============================================================================
# Install: prefix + I    Update: prefix + U    Clean: prefix + alt + u
# ------------------------------------------------------------------------------

# Catppuccin: Color theme (mocha variant)
set -g @plugin 'catppuccin/tmux'

# Thumbs: Quick-copy with hints for common patterns (URLs, hashes, IPs, paths)
# USAGE: M-y (or prefix + Space) → shows hints, press hint char to copy
set -g @plugin 'fcsonline/tmux-thumbs'

# Jump: Flash/sneak-style jumping - jump to any char on screen
# USAGE: M-s (or prefix + j) → type char to jump to, get hints, press hint to jump
set -g @plugin 'schasse/tmux-jump'

# Resurrect: Save/restore tmux sessions (windows, panes, layouts)
# USAGE: prefix + Ctrl+s = save, prefix + Ctrl+r = restore
# Sessions saved to ~/.tmux/resurrect/
set -g @plugin 'tmux-plugins/tmux-resurrect'

# Continuum: Auto-save sessions every 15 min, auto-restore on tmux start
# No manual action needed - just works in background
set -g @plugin 'tmux-plugins/tmux-continuum'

# TPM itself (must be last)
set -g @plugin 'tmux-plugins/tpm'

# ------------------------------------------------------------------------------
# Plugin Configuration
# ------------------------------------------------------------------------------
# Catppuccin theme settings
set -g @catppuccin_flavor 'mocha'                          # Color palette: latte, frappe, macchiato, mocha
set -g @catppuccin_window_status_style "rounded"           # Tab style
set -gq @catppuccin_window_current_text " #W#{@claude}"    # Current window format
set -gq @catppuccin_window_text " #W#{@claude}"            # Other windows format

# Resurrect + Continuum settings
set -g @continuum-restore 'on'                 # Auto-restore last session on tmux start
set -g @resurrect-capture-pane-contents 'on'   # Also save pane contents (scrollback)

# Jump settings
set -g @jump-key 'j'                           # Keybind: prefix + j

# Thumbs settings
# @thumbs-command: what happens on lowercase hint (just copy)
# @thumbs-upcase-command: what happens on uppercase hint (copy + paste)
# Uses set-buffer -w to trigger tmux's OSC52 (works over SSH)
set -g @thumbs-command 'tmux set-buffer -w -- "{}" && tmux display-message "Copied {}"'
set -g @thumbs-upcase-command 'tmux set-buffer -w -- "{}" && tmux paste-buffer && tmux display-message "Copied {}"'

# Extra patterns (in addition to built-in URLs, paths, git hashes, IPs, etc.)
# ESCAPING RULES (due to tmux-thumbs bugs):
#   - Quotes: use \x22 for " and \x27 for ' (parser regex [^"]+ breaks on quotes)
#   - Groups: use (?:...) non-capturing, OR use (...) capturing to extract matches
#             from surrounding context (thumbs returns capture group 1, not group 0)
#   - Curly braces {n}: work fine despite tmux adding quotes to the value
#   - Whitespace boundaries: use (?:^|\s)(pattern)(?:\s|$) to match standalone tokens
set -g @thumbs-regexp-1 '\x22[^\x22]+\x22'                               # "double quoted strings"
set -g @thumbs-regexp-2 '\x27[^\x27]+\x27'                               # 'single quoted strings'
set -g @thumbs-regexp-3 '(?:^|\s)([0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}|[0-9]{4}-[0-9]{2}-[0-9]{2})(?:\s|$)'  # ISO dates
set -g @thumbs-regexp-4 '(?:^|\s)([A-Z]{3,})(?:\s|$)'                    # UPPERCASE words (3+ chars)
set -g @thumbs-regexp-5 '(?:^|\s)([a-zA-Z][a-zA-Z0-9_-]*\.[a-zA-Z0-9]+)(?:\s|$)'  # filenames
set -g @thumbs-regexp-6 '(?:^|\s)([a-z0-9.-]+/[a-z0-9./-]+:[a-z0-9.-]+)(?:\s|$)'  # docker images

# ------------------------------------------------------------------------------
# TPM Bootstrap (auto-install if missing)
# ------------------------------------------------------------------------------
if "test ! -d ~/.tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && ~/.tmux/plugins/tpm/bin/install_plugins'"
run '~/.tmux/plugins/tpm/tpm'

# ------------------------------------------------------------------------------
# Status Bar (configured after plugins load)
# ------------------------------------------------------------------------------
set -g status-left ""
set -g status-right "#{E:@catppuccin_status_application}"
set -ag status-right "#{E:@catppuccin_status_session}"

# ------------------------------------------------------------------------------
# Local Overrides (machine-specific, not in version control)
# ------------------------------------------------------------------------------
source-file -q ~/.tmux.local.conf
