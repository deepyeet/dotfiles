# ==============================================================================
# TMUX CONFIGURATION
# ==============================================================================
# Prefix: C-\ (Ctrl+Backslash) - doesn't conflict with vim's C-b or C-g
# Plugin manager: TPM (auto-installed if missing)
# ==============================================================================

# ------------------------------------------------------------------------------
# Prefix Key
# ------------------------------------------------------------------------------
# Using C-\ because:
#   C-b conflicts with vim's page-up
#   C-a conflicts with readline (jump to start of line)
#   C-g is vim's escape/cancel key
unbind-key C-b
set -g prefix 'C-\'
bind-key 'C-\' send-prefix

# ------------------------------------------------------------------------------
# Terminal Settings
# ------------------------------------------------------------------------------
# True color support for modern terminals
set -ga terminal-overrides ",alacritty:RGB,xterm-256color:RGB,xterm-ghostty:RGB"

# Faster escape (important for vim)
set -g escape-time 0

# Bigger scrollback
set -g history-limit 50000

# Focus events for vim autoread
set -g focus-events on

# Clipboard integration (OSC 52 - works over SSH)
set -gs set-clipboard on

# Don't kill server when last session closes (easier to reattach)
set -g detach-on-destroy off

# Enable mouse for scrolling and pane selection
set -g mouse on

# ------------------------------------------------------------------------------
# Vi-style Copy Mode
# ------------------------------------------------------------------------------
setw -g mode-keys vi
bind-key -T copy-mode-vi 'v' send -X begin-selection
bind-key -T copy-mode-vi 'y' send -X copy-selection
bind-key -T copy-mode-vi 'Y' send -X copy-line
# Enter/+ moves down and goes to indentation (like vim's +)
bind-key -T copy-mode-vi Enter send -X cursor-down \; send -X back-to-indentation
bind-key -T copy-mode-vi '+' send -X cursor-down \; send -X back-to-indentation
bind-key -T copy-mode-vi '_' send -X back-to-indentation
# Click clears selection instead of copying (less accidental copies)
bind-key -T copy-mode-vi MouseDown1Pane send -X clear-selection
unbind-key -T copy-mode-vi MouseDragEnd1Pane

# M-b enters copy mode and scrolls up a page (like vim's C-b)
bind -n M-b copy-mode -eu
bind -T copy-mode-vi M-f send -X page-down

# M-/ enters copy mode (M-c taken by fzf)
bind -n M-/ copy-mode

# ------------------------------------------------------------------------------
# Pane Navigation (Alt+hjkl - no prefix needed)
# ------------------------------------------------------------------------------
bind -n M-h select-pane -L
bind -n M-l select-pane -R
bind -n M-k select-pane -U
bind -n M-j select-pane -D

# ------------------------------------------------------------------------------
# Window Management
# ------------------------------------------------------------------------------
# M-t: New window
bind -n M-t new-window

# M-d/M-D: Split horizontal/vertical (at current path)
bind -n M-d split-window -h -c "#{pane_current_path}"
bind -n M-D split-window -c "#{pane_current_path}"

# M-p/M-n: Previous/next window
bind -n M-p previous-window
bind -n M-n next-window

# M-P/M-N: Move window left/right
bind -n M-P swap-window -t -1 \; select-window -t -1
bind -n M-N swap-window -t +1 \; select-window -t +1

# ------------------------------------------------------------------------------
# Session Management
# ------------------------------------------------------------------------------
bind -n M-C command-prompt "new-session -s %%"  # Create new session
bind -n M-S choose-session                       # Session picker
bind -n M-( switch-client -p                     # Previous session
bind -n M-) switch-client -n                     # Next session
bind -n M-` switch-client -l                     # Toggle last two sessions

# ------------------------------------------------------------------------------
# Pane Management
# ------------------------------------------------------------------------------
bind -n M-T break-pane   # Move pane to its own window
bind -n M-J choose-tree "join-pane -t '%%'"  # Join pane from another window
bind -n M-r next-layout  # Cycle through pane layouts

# ------------------------------------------------------------------------------
# Window Selection (Alt+number)
# ------------------------------------------------------------------------------
set -g base-index 1
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9
bind -n M-0 select-window -t 0

# ------------------------------------------------------------------------------
# Misc Bindings
# ------------------------------------------------------------------------------
bind -n M-, command-prompt -I "#W" "rename-window -- '%%'"
bind -n M-. command-prompt -I "#S" "rename-session -- '%%'"
bind -n M-w confirm-before -p "kill pane #P? (y/n)" kill-pane  # Like browser close-tab
bind -n M-z resize-pane -Z  # Toggle pane zoom
bind r source-file ~/.tmux.conf \; display "Config reloaded"

# ==============================================================================
# Passthrough Mode (for nested tmux sessions)
# ==============================================================================
# M-\\ toggles a mode where all keys are passed through to the inner session.
# The status bar is hidden to indicate passthrough mode is active.
# ------------------------------------------------------------------------------

# Passthrough ON: Unset prefix, set key-table to 'passthrough', hide status bar
bind-key -n M-\\ \
  set-option prefix None \; \
  set-option key-table passthrough \; \
  refresh-client -S

# Passthrough OFF: Restore prefix, unset key-table, show status bar
# (This is only bound in the 'passthrough' table)
bind-key -T passthrough M-\\ \
  set-option -u prefix \; \
  set-option -u key-table \; \
  refresh-client -S

# ==============================================================================
# PLUGINS (managed by TPM)
# ==============================================================================
# Install: prefix + I    Update: prefix + U    Clean: prefix + alt + u
# ------------------------------------------------------------------------------

# Catppuccin: Color theme (mocha variant)
set -g @plugin 'catppuccin/tmux'

# Fingers: Quick-copy with hints for common patterns (URLs, hashes, IPs, paths)
# USAGE: M-y → shows hints, press hint char to copy; M-s → jump to match
set -g @plugin 'Morantron/tmux-fingers'

# Resurrect: Save/restore tmux sessions (windows, panes, layouts)
# USAGE: prefix + Ctrl+s = save, prefix + Ctrl+r = restore
# Sessions saved to ~/.tmux/resurrect/
set -g @plugin 'tmux-plugins/tmux-resurrect'

# Continuum: Auto-save sessions every 15 min, auto-restore on tmux start
# No manual action needed - just works in background
set -g @plugin 'tmux-plugins/tmux-continuum'

# TPM itself (must be last)
set -g @plugin 'tmux-plugins/tpm'

# ------------------------------------------------------------------------------
# Plugin Configuration
# ------------------------------------------------------------------------------
# Catppuccin theme settings
set -g @catppuccin_flavor 'mocha'                          # Color palette: latte, frappe, macchiato, mocha
set -g @catppuccin_window_status_style "rounded"           # Tab style
set -g @normal_window_text " #W#{@claude}"
set -g @passthrough_mode_text "#[fg=#{@thm_crust},bg=#{@thm_red},bold]#{E:@normal_window_text} [REMOTE]"
set -g @passthrough_mode_text_inactive "#[fg=#{@thm_crust},bg=#{@thm_maroon},bold]#{E:@normal_window_text}"
set -g @catppuccin_window_current_text '#{?#{==:#{client_key_table},passthrough},#{E:@passthrough_mode_text},#{E:@normal_window_text}}'
set -g @catppuccin_window_text '#{?#{==:#{client_key_table},passthrough},#{E:@passthrough_mode_text_inactive},#{E:@normal_window_text}}'

# Resurrect + Continuum settings
set -g @continuum-restore 'on'                 # Auto-restore last session on tmux start
set -g @resurrect-capture-pane-contents 'on'   # Also save pane contents (scrollback)

# Fingers settings
# IMPORTANT: Named capture groups (?<match>...) ONLY work when surrounded by
# literal context (quotes, backticks, etc). Without context, hint placement breaks
# and corrupts the display. For standalone patterns (dates, hashes, IDs), don't
# use (?<match>...) - just match the full pattern directly.
#   Works:    "(?<match>[^"]+)"     # quotes provide literal context
#   Broken:   \b(?<match>\d+)\b     # word boundaries are zero-width, no context
set -g @fingers-pattern-0 '"(?<match>[^"]+)"'                             # "double quoted" -> content only
set -g @fingers-pattern-1 "'(?<match>[^']+)'"                             # 'single quoted' -> content only
set -g @fingers-pattern-2 '\d{4}-\d{2}-\d{2}(?:T\d{2}:\d{2}:\d{2})?'  # ISO dates
set -g @fingers-pattern-3 '[a-z0-9.-]+(?:/[a-z0-9./-]+)?:[a-z0-9.-]+'  # docker/identifier:hash
set -g @fingers-pattern-4 '(?:--[a-zA-Z0-9-]+=(?<match>[a-zA-Z0-9_./#:@~%+-]+)|--[a-zA-Z0-9-]+\s+(?<match>[a-zA-Z0-9_./#:@~%+-]+)|-[a-zA-Z]\s+(?<match>[a-zA-Z0-9_./#:@~%+-]+))'  # CLI arg values
set -g @fingers-pattern-5 '`(?<match>[^`]+)`'                             # `backticks` -> content only

# Plugin Bindings
bind -n M-y run -b "#{@fingers-cli} start #{pane_id}"                      # Quick-copy (yank)
bind -n M-s run -b "#{@fingers-cli} start #{pane_id} --mode jump"          # Jump to match (sneak)

# ------------------------------------------------------------------------------
# TPM Bootstrap (auto-install if missing)
# ------------------------------------------------------------------------------
if "test ! -d ~/.tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && ~/.tmux/plugins/tpm/bin/install_plugins'"
run '~/.tmux/plugins/tpm/tpm'

# ------------------------------------------------------------------------------
# Status Bar (configured after plugins load)
# ------------------------------------------------------------------------------
set -g status-left ""
set -g status-right "#{E:@catppuccin_status_application}"
set -ag status-right "#{E:@catppuccin_status_session}"

# ------------------------------------------------------------------------------
# Local Overrides (machine-specific, not in version control)
# ------------------------------------------------------------------------------
source-file -q ~/.tmux.local.conf
