# ==============================================================================
# TMUX CONFIGURATION
# ==============================================================================
# Prefix: C-\ (Ctrl+Backslash) - doesn't conflict with vim's C-b or C-g
# Plugin manager: TPM (auto-installed if missing)
# ==============================================================================

# ------------------------------------------------------------------------------
# Prefix Key
# ------------------------------------------------------------------------------
# Using C-\ because:
#   C-b conflicts with vim's page-up
#   C-a conflicts with readline (jump to start of line)
#   C-g is vim's escape/cancel key
unbind-key C-b
set -g prefix 'C-\'
bind-key 'C-\' send-prefix

# ------------------------------------------------------------------------------
# Terminal Settings
# ------------------------------------------------------------------------------
# True color support for modern terminals
set -ga terminal-overrides ",alacritty:RGB,xterm-256color:RGB,xterm-ghostty:RGB"

# Faster escape (important for vim)
set -g escape-time 0

# Bigger scrollback
set -g history-limit 50000

# Focus events for vim autoread
set -g focus-events on

# Clipboard integration (OSC 52 - works over SSH)
set -gs set-clipboard on

# Don't kill server when last session closes (easier to reattach)
set -g detach-on-destroy off

# Enable mouse for scrolling and pane selection
set -g mouse on

# ------------------------------------------------------------------------------
# Vi-style Copy Mode
# ------------------------------------------------------------------------------
setw -g mode-keys vi
bind-key -T copy-mode-vi 'v' send -X begin-selection
bind-key -T copy-mode-vi 'y' send -X copy-selection
bind-key -T copy-mode-vi 'Y' send -X copy-line
# Enter/+ moves down and goes to indentation (like vim's +)
bind-key -T copy-mode-vi Enter send -X cursor-down \; send -X back-to-indentation
bind-key -T copy-mode-vi '+' send -X cursor-down \; send -X back-to-indentation
bind-key -T copy-mode-vi '_' send -X back-to-indentation
# Click clears selection instead of copying (less accidental copies)
bind-key -T copy-mode-vi MouseDown1Pane send -X clear-selection
unbind-key -T copy-mode-vi MouseDragEnd1Pane

# M-b enters copy mode and scrolls up a page (like vim's C-b)
bind -n M-b copy-mode -eu
bind -T copy-mode-vi M-f send -X page-down

# ------------------------------------------------------------------------------
# Pane Navigation (Alt+hjkl - no prefix needed)
# ------------------------------------------------------------------------------
bind -n M-h select-pane -L
bind -n M-l select-pane -R
bind -n M-k select-pane -U
bind -n M-j select-pane -D

# ------------------------------------------------------------------------------
# Window Management
# ------------------------------------------------------------------------------
# M-t: New window
bind -n M-t new-window

# M-d/M-D: Split horizontal/vertical (at current path)
bind -n M-d split-window -h -c "#{pane_current_path}"
bind -n M-D split-window -c "#{pane_current_path}"

# M-p/M-n: Previous/next window
bind -n M-p previous-window
bind -n M-n next-window

# M-P/M-N: Move window left/right
bind -n M-P swap-window -t -1
bind -n M-N swap-window -t +1

# ------------------------------------------------------------------------------
# Session Management
# ------------------------------------------------------------------------------
bind -n M-S command-prompt "new-session -s %%"
bind -n M-( switch-client -p
bind -n M-) switch-client -n
bind -n M-s choose-session
bind -n M-` switch-client -l  # Toggle between last two sessions

# ------------------------------------------------------------------------------
# Pane Management
# ------------------------------------------------------------------------------
bind -n M-T break-pane  # Move pane to its own window

# ------------------------------------------------------------------------------
# Window Selection (Alt+number)
# ------------------------------------------------------------------------------
set -g base-index 1
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9
bind -n M-0 select-window -t 0

# ------------------------------------------------------------------------------
# Misc Bindings
# ------------------------------------------------------------------------------
bind -n M-c copy-mode
bind -n M-, command-prompt -I "#W" "rename-window -- '%%'"
bind -n M-. command-prompt -I "#S" "rename-session -- '%%'"
bind -n M-x confirm-before -p "kill pane #P? (y/n)" kill-pane
bind -n M-z resize-pane -Z  # Toggle pane zoom
bind r source-file ~/.tmux.conf \; display "Config reloaded"

# ==============================================================================
# PLUGINS (managed by TPM)
# ==============================================================================
set -g @plugin 'catppuccin/tmux'
set -g @plugin 'Morantron/tmux-fingers'
set -g @plugin 'tmux-plugins/tpm'

# ------------------------------------------------------------------------------
# Plugin Configuration
# ------------------------------------------------------------------------------
# Catppuccin theme
set -g @catppuccin_flavor 'mocha'
set -g @catppuccin_window_status_style "rounded"
set -ogq @catppuccin_window_current_text " #W"
set -ogq @catppuccin_window_text " #W"

# ------------------------------------------------------------------------------
# TPM Bootstrap (auto-install if missing)
# ------------------------------------------------------------------------------
if "test ! -d ~/.tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && ~/.tmux/plugins/tpm/bin/install_plugins'"
run '~/.tmux/plugins/tpm/tpm'

# ------------------------------------------------------------------------------
# Status Bar (configured after plugins load)
# ------------------------------------------------------------------------------
set -g status-left ""
set -g status-right "#{E:@catppuccin_status_application}"
set -ag status-right "#{E:@catppuccin_status_session}"

# Fingers: quick-copy plugin trigger
bind -n M-y run -b "#{@fingers-cli} start #{pane_id}"
