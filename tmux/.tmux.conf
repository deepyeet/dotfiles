# ==============================================================================
# TMUX CONFIGURATION
# ==============================================================================
# Prefix: C-\ (Ctrl+Backslash) - doesn't conflict with vim's C-b or C-g
# Plugin manager: TPM (auto-installed if missing)
# ==============================================================================

# ------------------------------------------------------------------------------
# Prefix Key
# ------------------------------------------------------------------------------
# Using C-s because:
#   C-b conflicts with vim's page-up
#   C-a conflicts with readline (jump to start of line)
#   C-g is vim's escape/cancel key
#   C-s is "fuck the terminal" button which everyone hates. It's dead anyway.
unbind-key C-b
set -g prefix 'C-s'
# bind-key 'C-\' send-prefix

# ------------------------------------------------------------------------------
# Terminal Settings
# ------------------------------------------------------------------------------
# True color support for modern terminals
set -ga terminal-overrides ",alacritty:RGB,xterm-256color:RGB,xterm-ghostty:RGB"

# Faster escape (important for vim)
set -g escape-time 0

# Bigger scrollback
set -g history-limit 50000

# Focus events for vim autoread
set -g focus-events on

# Clipboard integration (OSC 52 - works over SSH)
set -gs set-clipboard on

# Don't kill server when last session closes (easier to reattach)
# No - no more sessions for me, thank
# set -g detach-on-destroy off

# Enable mouse for scrolling and pane selection
set -g mouse on

# ------------------------------------------------------------------------------
# Vi-style Copy Mode
# ------------------------------------------------------------------------------
setw -g mode-keys vi
bind-key -T copy-mode-vi 'v' send -X begin-selection
bind-key -T copy-mode-vi 'y' send -X copy-selection
bind-key -T copy-mode-vi 'Y' send -X copy-line
# Enter/+ moves down and goes to indentation (like vim's +)
bind-key -T copy-mode-vi Enter send -X cursor-down \; send -X back-to-indentation
bind-key -T copy-mode-vi '+' send -X cursor-down \; send -X back-to-indentation
bind-key -T copy-mode-vi '_' send -X back-to-indentation
# Click clears selection instead of copying (less accidental copies)
bind-key -T copy-mode-vi MouseDown1Pane send -X clear-selection
unbind-key -T copy-mode-vi MouseDragEnd1Pane

# M-b enters copy mode and scrolls up a page (like vim's C-b)
bind -n M-b copy-mode -eu
bind -T copy-mode-vi M-f send -X page-down

# YOLO: edit the buffer in nvim, because copy mode is trash. Just rely on prefix+[ for copy mode if I need something faste
bind v run-shell "tmux display-popup -E -w 90% -h 90% \"tmux capture-pane -pS -100000 #{?alternate_on,,-E #{cursor_y}} -t \\#{pane_id} | nvim -R -c 'set buftype=nofile scrolloff=0' -c 'normal Gzb' -c 'nnoremap <buffer> q :qa!<CR>' -\""

# ------------------------------------------------------------------------------
# Pane Navigation (Alt+hjkl - no prefix needed)
# ------------------------------------------------------------------------------
bind -n M-h select-pane -L
bind -n M-l select-pane -R
bind -n M-k select-pane -U
bind -n M-j select-pane -D

# ------------------------------------------------------------------------------
# Window Management
# ------------------------------------------------------------------------------
# I'm going back to prefix! Only critical binds bypass prefix now

# M-t: New window -> prefix c - needs to be easy!
# M-c is useful for fzf so bind it to M-t (new tab-ism)
bind -n M-t new-window

# M-d/M-D: Split horizontal/vertical (at current path)
# Happens *all the time*, and frankly prefix % or prefix " is horrid
bind -n M-d split-window -h -c "#{pane_current_path}"
bind -n M-D split-window -c "#{pane_current_path}"

# M-p/M-n: Previous/next window
# Happens ALL THE TIME no way in HELL am I pressing prefix + n itself
bind -n M-p previous-window
bind -n M-n next-window

# M-P/M-N: Move window left/right
bind -n M-P swap-window -t -1 \; select-window -t -1
bind -n M-N swap-window -t +1 \; select-window -t +1

# ------------------------------------------------------------------------------
# Session Management
# ------------------------------------------------------------------------------
#bind -n M-C command-prompt "new-session -s %%"  # Create new session
#bind -n M-S choose-session                       # Session picker
#bind -n M-( switch-client -p                     # Previous session
#bind -n M-) switch-client -n                     # Next session
#bind -n M-` switch-client -l                     # Toggle last two sessions

# ------------------------------------------------------------------------------
# Pane Management
# ------------------------------------------------------------------------------
# Doesn't happen that often - use prefix-!
# bind -n M-T break-pane   # Move pane to its own window

bind j choose-tree "join-pane -t '%%'"  # Join pane from another window

# Keep this one - frankly hitting prefix space repeatedly sucks
# M-r for rotate - alt+space conflicts with too much stuff
bind -n M-r next-layout  # Cycle through pane layouts

# ------------------------------------------------------------------------------
# Window Selection (Alt+number)
# ------------------------------------------------------------------------------
set -g base-index 1
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9
bind -n M-0 select-window -t 0

# ------------------------------------------------------------------------------
# Misc Bindings
# ------------------------------------------------------------------------------
#bind -n M-, command-prompt -I "#W" "rename-window -- '%%'"
#bind -n M-. command-prompt -I "#S" "rename-session -- '%%'"
#bind -n M-w confirm-before -p "kill pane #P? (y/n)" kill-pane  # Like browser close-tab

# This is far, far too good to bind to prefix
bind -n M-z resize-pane -Z  # Toggle pane zoom

bind r source-file ~/.tmux.conf \; display "Config reloaded"

# ==============================================================================
# Passthrough Mode (for nested tmux sessions)
# ==============================================================================
# M-\\ toggles a mode where all keys are passed through to the inner session.
# The status bar is hidden to indicate passthrough mode is active.
# ------------------------------------------------------------------------------

# Passthrough ON: Disable prefix, switch to passthrough key-table, set red status bar
bind-key \\ \
  set-option prefix None \; \
  set-option key-table passthrough \; \
  set-option status-style "bg=#{@thm_red},fg=#{@thm_crust}" \; \
  refresh-client -S

# Passthrough OFF: Restore prefix, return to root key-table, restore catppuccin status bar
bind-key -T passthrough \\ \
  set-option -u prefix \; \
  set-option -u key-table \; \
  set-option status-style "bg=#{@thm_mantle},fg=#{@thm_fg}" \; \
  refresh-client -S

# ==============================================================================
# PLUGINS (managed by TPM)
# ==============================================================================
# Install: prefix + I    Update: prefix + U    Clean: prefix + alt + u
# ------------------------------------------------------------------------------

# Catppuccin: Color theme (mocha variant)
set -g @plugin 'catppuccin/tmux'

# Fingers: Quick-copy with hints for common patterns (URLs, hashes, IPs, paths)
set -g @plugin 'Morantron/tmux-fingers'

# Resurrect: Save/restore tmux sessions (windows, panes, layouts)
# USAGE: prefix + Ctrl+s = save, prefix + Ctrl+r = restore
# Sessions saved to ~/.tmux/resurrect/
set -g @plugin 'tmux-plugins/tmux-resurrect'

# Continuum: Auto-save sessions every 15 min, auto-restore on tmux start
# No manual action needed - just works in background
set -g @plugin 'tmux-plugins/tmux-continuum'

# TPM itself (must be last)
set -g @plugin 'tmux-plugins/tpm'

# ------------------------------------------------------------------------------
# Plugin Configuration
# ------------------------------------------------------------------------------
# Catppuccin theme settings
set -g @catppuccin_flavor 'mocha'                          # Color palette: latte, frappe, macchiato, mocha
set -g @catppuccin_window_status_style "rounded"           # Tab style
set -g @catppuccin_window_text " #W#{@claude}"
set -g @catppuccin_window_current_text " #W#{@claude}"

# Resurrect + Continuum settings
set -g @continuum-restore 'off'                # Auto-restore last session on tmux start
set -g @resurrect-capture-pane-contents 'on'   # Also save pane contents (scrollback)

# Fingers settings
# IMPORTANT: Named capture groups (?<match>...) ONLY work when surrounded by
# literal context (quotes, backticks, etc). Without context, hint placement breaks
# and corrupts the display. For standalone patterns (dates, hashes, IDs), don't
# use (?<match>...) - just match the full pattern directly.
#   Works:    "(?<match>[^"]+)"     # quotes provide literal context
#   Broken:   \b(?<match>\d+)\b     # word boundaries are zero-width, no context
set -g @fingers-pattern-0 '"(?<match>[^"]+)"'                             # "double quoted" -> content only
set -g @fingers-pattern-1 "'(?<match>[^']+)'"                             # 'single quoted' -> content only
set -g @fingers-pattern-2 '\d{4}-\d{2}-\d{2}(?:T\d{2}:\d{2}:\d{2})?'  # ISO dates
set -g @fingers-pattern-3 '[a-z0-9.-]+(?:/[a-z0-9./-]+)?:[a-z0-9.-]+'  # docker/identifier:hash
set -g @fingers-pattern-4 '(?:--[a-zA-Z0-9-]+=(?<match>[a-zA-Z0-9_./#:@~%+-]+)|--[a-zA-Z0-9-]+\s+(?<match>[a-zA-Z0-9_./#:@~%+-]+)|-[a-zA-Z]\s+(?<match>[a-zA-Z0-9_./#:@~%+-]+))'  # CLI arg values
set -g @fingers-pattern-5 '`(?<match>[^`]+)`'                             # `backticks` -> content only

# Plugin Bindings
# Originally bound but, just gonna use prefix+F and prefix+J for fingers...

# ------------------------------------------------------------------------------
# TPM Bootstrap (auto-install if missing)
# ------------------------------------------------------------------------------
if "test ! -d ~/.tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && ~/.tmux/plugins/tpm/bin/install_plugins'"
run '~/.tmux/plugins/tpm/tpm'

# ------------------------------------------------------------------------------
# Status Bar (configured after plugins load)
# ------------------------------------------------------------------------------
set -g status-left ""
set -g status-right "#{E:@catppuccin_status_application}#{E:@catppuccin_status_session}"

# ==============================================================================
# PASSTHROUGH MODE (captures formats, then overrides with conditionals)
# ==============================================================================
# Capture current formats before we override them
run-shell 'tmux set -g @_normal_wsf "$(tmux show -gqv window-status-format)"'
run-shell 'tmux set -g @_normal_wscf "$(tmux show -gqv window-status-current-format)"'
run-shell 'tmux set -g @_normal_status_left "$(tmux show -gqv status-left)"'
run-shell 'tmux set -g @_normal_status_right "$(tmux show -gqv status-right)"'

# Override with conditionals
set -g status-left-length 20
set -g status-left "#{?#{==:#{client_key_table},passthrough},#[align=centre bold] PASSTHROUGH ,#{E:@_normal_status_left}}"
set -g status-right "#{?#{==:#{client_key_table},passthrough},,#{E:@_normal_status_right}}"
set -g window-status-format "#{?#{==:#{client_key_table},passthrough},,#{E:@_normal_wsf}}"
set -g window-status-current-format "#{?#{==:#{client_key_table},passthrough},,#{E:@_normal_wscf}}"

# ------------------------------------------------------------------------------
# Local Overrides (machine-specific, not in version control)
# ------------------------------------------------------------------------------
source-file -q ~/.tmux.local.conf
